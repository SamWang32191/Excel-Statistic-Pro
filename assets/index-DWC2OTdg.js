(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))f(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&f(c)}).observe(document,{childList:!0,subtree:!0});function m(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function f(t){if(t.ep)return;t.ep=!0;const n=m(t);fetch(t.href,n)}})();document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("dropZone"),d=document.getElementById("fileInput"),m=document.getElementById("rocDate"),f=document.getElementById("genderCol"),t=document.getElementById("ageCol"),n=document.getElementById("previewSection"),c=document.getElementById("uploadBtn"),y=document.getElementById("statusMessage"),h=document.getElementById("fileInfo"),E=document.getElementById("removeFile"),C=document.getElementById("genderStats"),N=document.getElementById("ageStats");let u=null;function I(e){if(!e)return-1;let r=0;const s=e.toUpperCase();for(let a=0;a<s.length;a++)r=r*26+s.charCodeAt(a)-64;return r-1}l.onclick=()=>d.click(),l.ondragover=e=>{e.preventDefault(),l.classList.add("dragover")},l.ondragleave=()=>l.classList.remove("dragover"),l.ondrop=e=>{e.preventDefault(),l.classList.remove("dragover"),e.dataTransfer.files.length&&L(e.dataTransfer.files[0])},d.onchange=e=>{e.target.files.length&&L(e.target.files[0])},E.onclick=e=>{e.stopPropagation(),w()};function L(e){if(!e.name.match(/\.(xlsx|xls)$/)){g("不支援的檔案格式","error");return}u=e,S()}function S(){if(!u)return;const e=new FileReader;e.onload=r=>{try{const s=new Uint8Array(r.target.result),a=XLSX.read(s,{type:"array"}),i=a.SheetNames[0],v=a.Sheets[i],p=XLSX.utils.sheet_to_json(v,{header:1});x(p,u.name)}catch(s){console.error(s),g("讀取檔案失敗","error")}},e.readAsArrayBuffer(u)}function w(){d.value="",u=null,h.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),n.classList.add("hidden"),c.disabled=!0,g("請輸入設定並上傳檔案","")}function x(e,r){const s=I(f.value||"G"),a=I(t.value||"F"),i={男:0,女:0,"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0};for(let v=1;v<e.length;v++){const p=e[v];if(s!==-1&&p[s]!==void 0){const o=p[s].toString().trim();o==="男"?i.男++:o==="女"&&i.女++}if(a!==-1&&p[a]!==void 0){const o=parseInt(p[a]);isNaN(o)||(o<=49?i["<= 49"]++:o>=50&&o<=64?i["50 >= && <= 64"]++:o>=65&&o<=74?i["65 >= && <= 74"]++:o>=75&&o<=84?i["75 >= && <= 84"]++:o>=85&&i["85 >="]++)}}D(i),h.classList.remove("hidden"),h.querySelector(".file-name").textContent=r,document.querySelector(".upload-content").classList.add("hidden"),n.classList.remove("hidden"),g("檔案已就緒，請確認統計結果","success"),B()}function D(e){C.innerHTML=`
            <div class="stat-item"><span>男</span> <span class="stat-value">${e.男}</span></div>
            <div class="stat-item"><span>女</span> <span class="stat-value">${e.女}</span></div>
        `,N.innerHTML=`
            <div class="stat-item"><span><= 49</span> <span class="stat-value">${e["<= 49"]}</span></div>
            <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${e["50 >= && <= 64"]}</span></div>
            <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${e["65 >= && <= 74"]}</span></div>
            <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${e["75 >= && <= 84"]}</span></div>
            <div class="stat-item"><span>>= 85</span> <span class="stat-value">${e["85 >="]}</span></div>
        `,c.dataset.stats=JSON.stringify(e)}function B(){const e=m.value.length>=5,r=f.value.trim().length>0,s=t.value.trim().length>0,a=!!u;c.disabled=!(e&&r&&s&&a)}[m,f,t].forEach(e=>{e.oninput=()=>{B(),u&&S()}}),c.onclick=async()=>{JSON.parse(c.dataset.stats),m.value;{g("錯誤: 未設定 GAS URL 環境變數","error");return}};function g(e,r){y.textContent=e,y.className="status-message "+r}});
