(function(){const v=document.createElement("link").relList;if(v&&v.supports&&v.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))g(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const h of l.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&g(h)}).observe(document,{childList:!0,subtree:!0});function y(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function g(i){if(i.ep)return;i.ep=!0;const l=y(i);fetch(i.href,l)}})();document.addEventListener("DOMContentLoaded",()=>{const p=document.getElementById("dropZone"),v=document.getElementById("fileInput"),y=document.getElementById("citySelect"),g=document.getElementById("rocDate"),i=document.getElementById("genderCol"),l=document.getElementById("ageCol"),h=document.getElementById("livingCol"),E=document.getElementById("cmsCol"),x=document.getElementById("previewSection"),m=document.getElementById("uploadBtn"),D=document.getElementById("statusMessage"),B=document.getElementById("fileInfo"),A=document.getElementById("removeFile"),F=document.getElementById("genderStats"),P=document.getElementById("ageStats"),b=document.getElementById("livingStats"),M=document.getElementById("cmsStats"),R="https://script.google.com/macros/s/AKfycbwfeDQPIplOO7e6uqxacl15bFoQ470bcGvufeXXFEQoAER7yjDBPrlI1WllKS8vrh2k/exec";let f=null;function C(e){if(!e)return-1;let a=0;const s=e.toUpperCase();for(let c=0;c<s.length;c++)a=a*26+s.charCodeAt(c)-64;return a-1}p.onclick=()=>v.click(),p.ondragover=e=>{e.preventDefault(),p.classList.add("dragover")},p.ondragleave=()=>p.classList.remove("dragover"),p.ondrop=e=>{e.preventDefault(),p.classList.remove("dragover"),e.dataTransfer.files.length&&N(e.dataTransfer.files[0])},v.onchange=e=>{e.target.files.length&&N(e.target.files[0])},A.onclick=e=>{e.stopPropagation(),T()};function N(e){if(!e.name.match(/\.(xlsx|xls)$/)){u("不支援的檔案格式","error");return}f=e,O()}function O(){if(!f)return;const e=new FileReader;e.onload=a=>{try{const s=new Uint8Array(a.target.result),c=XLSX.read(s,{type:"array"}),d=c.SheetNames[0],t=c.Sheets[d],n=XLSX.utils.sheet_to_json(t,{header:1});j(n,f.name)}catch(s){console.error(s),u("讀取檔案失敗","error")}},e.readAsArrayBuffer(f)}function T(){v.value="",f=null,B.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),x.classList.add("hidden"),m.disabled=!0,u("請選擇縣市、輸入月份並上傳檔案","")}function j(e,a){const s=C(i.value||"G"),c=C(l.value||"F"),d=C(h.value||"O"),t=C(E.value||"J"),n={男:0,女:0,"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0},I={},S={};for(let L=1;L<e.length;L++){const r=e[L];if(s!==-1&&r[s]!==void 0){const o=r[s].toString().trim();o==="男"?n.男++:o==="女"&&n.女++}if(c!==-1&&r[c]!==void 0){const o=parseInt(r[c]);isNaN(o)||(o<=49?n["<= 49"]++:o>=50&&o<=64?n["50 >= && <= 64"]++:o>=65&&o<=74?n["65 >= && <= 74"]++:o>=75&&o<=84?n["75 >= && <= 84"]++:o>=85&&n["85 >="]++)}if(d!==-1&&r[d]!==void 0){let o=r[d].toString().trim();o&&(o==="其他類型居住狀況"&&(o="其他"),I[o]=(I[o]||0)+1)}if(t!==-1&&r[t]!==void 0){const o=r[t].toString().trim();o&&(S[o]=(S[o]||0)+1)}}q(n,I,S),B.classList.remove("hidden"),B.querySelector(".file-name").textContent=a,document.querySelector(".upload-content").classList.add("hidden"),x.classList.remove("hidden"),u("檔案已就緒，請確認統計結果","success"),w()}function q(e,a,s){F.innerHTML=`
            <div class="stat-item"><span>男</span> <span class="stat-value">${e.男}</span></div>
            <div class="stat-item"><span>女</span> <span class="stat-value">${e.女}</span></div>
        `,P.innerHTML=`
            <div class="stat-item"><span><= 49</span> <span class="stat-value">${e["<= 49"]}</span></div>
            <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${e["50 >= && <= 64"]}</span></div>
            <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${e["65 >= && <= 74"]}</span></div>
            <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${e["75 >= && <= 84"]}</span></div>
            <div class="stat-item"><span>>= 85</span> <span class="stat-value">${e["85 >="]}</span></div>
        `;const c=["獨居","獨居(兩老)","與家人或其他人同住","與朋友同住","其他"],d=c.filter(r=>a[r]!==void 0).map(r=>`<div class="stat-item"><span>${r}</span> <span class="stat-value">${a[r]}</span></div>`).join("");b.innerHTML=d||'<div class="stat-item"><span>無資料</span></div>';const t=["1","2","3","4","5","6","7","8"],n=Object.keys(s).filter(r=>t.indexOf(r)===-1).sort(),I=t.concat(n),S=I.filter(r=>s[r]!==void 0).map(r=>`<div class="stat-item"><span>${r} 級</span> <span class="stat-value">${s[r]}</span></div>`).join("");M.innerHTML=S||'<div class="stat-item"><span>無資料</span></div>';const L=G(e,a,s,c,I);m.dataset.outputRows=JSON.stringify(L)}function G(e,a,s,c,d){const t=[];return t.push(["【性別統計】",""]),t.push(["男",e.男||0]),t.push(["女",e.女||0]),t.push(["",""]),t.push(["【年齡分佈】",""]),t.push(["<= 49",e["<= 49"]||0]),t.push(["50 >= && <= 64",e["50 >= && <= 64"]||0]),t.push(["65 >= && <= 74",e["65 >= && <= 74"]||0]),t.push(["75 >= && <= 84",e["75 >= && <= 84"]||0]),t.push(["85 >=",e["85 >="]||0]),t.push(["",""]),t.push(["【居住狀況】",""]),c.forEach(n=>{a[n]!==void 0&&t.push([n,a[n]])}),t.push(["",""]),t.push(["【CMS 等級】",""]),d.forEach(n=>{s[n]!==void 0&&t.push([n+" 級",s[n]])}),t}function w(){const e=y.value!=="",a=g.value.length>=2,s=i.value.trim().length>0,c=l.value.trim().length>0,d=h.value.trim().length>0,t=E.value.trim().length>0,n=!!f;m.disabled=!(e&&a&&s&&c&&d&&t&&n)}[y,g,i,l,h,E].forEach(e=>{e.addEventListener("input",()=>{w(),f&&O()}),e.addEventListener("change",()=>{w(),f&&O()})}),m.onclick=async()=>{if(!y.value){u("請選擇縣市","error");return}if(g.value.length<2){u("請輸入月份","error");return}const e=JSON.parse(m.dataset.outputRows||"[]"),a=y.value+g.value;$(!0),u("正在同步至 Google Sheet...","success");try{await fetch(R,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:a,rows:e})}),u("同步完成！請檢查您的 Google Sheet","success")}catch(s){console.error(s),u("同步失敗: "+s.message,"error")}finally{$(!1)}};function $(e){m.disabled=e,m.querySelector(".btn-text").classList.toggle("hidden",e),m.querySelector(".loader").classList.toggle("hidden",!e)}function u(e,a){D.textContent=e,D.className="status-message "+a}});
