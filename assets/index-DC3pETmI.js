(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))p(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&p(a)}).observe(document,{childList:!0,subtree:!0});function g(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function p(t){if(t.ep)return;t.ep=!0;const n=g(t);fetch(t.href,n)}})();document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("dropZone"),d=document.getElementById("fileInput"),g=document.getElementById("rocDate"),p=document.getElementById("genderCol"),t=document.getElementById("ageCol"),n=document.getElementById("previewSection"),a=document.getElementById("uploadBtn"),y=document.getElementById("statusMessage"),h=document.getElementById("fileInfo"),C=document.getElementById("removeFile"),O=document.getElementById("genderStats"),b=document.getElementById("ageStats"),x="https://script.google.com/macros/s/AKfycbwfeDQPIplOO7e6uqxacl15bFoQ470bcGvufeXXFEQoAER7yjDBPrlI1WllKS8vrh2k/exec";let u=null;function S(e){if(!e)return-1;let o=0;const s=e.toUpperCase();for(let r=0;r<s.length;r++)o=o*26+s.charCodeAt(r)-64;return o-1}i.onclick=()=>d.click(),i.ondragover=e=>{e.preventDefault(),i.classList.add("dragover")},i.ondragleave=()=>i.classList.remove("dragover"),i.ondrop=e=>{e.preventDefault(),i.classList.remove("dragover"),e.dataTransfer.files.length&&I(e.dataTransfer.files[0])},d.onchange=e=>{e.target.files.length&&I(e.target.files[0])},C.onclick=e=>{e.stopPropagation(),N()};function I(e){if(!e.name.match(/\.(xlsx|xls)$/)){f("不支援的檔案格式","error");return}u=e,L()}function L(){if(!u)return;const e=new FileReader;e.onload=o=>{try{const s=new Uint8Array(o.target.result),r=XLSX.read(s,{type:"array"}),l=r.SheetNames[0],v=r.Sheets[l],m=XLSX.utils.sheet_to_json(v,{header:1});w(m,u.name)}catch(s){console.error(s),f("讀取檔案失敗","error")}},e.readAsArrayBuffer(u)}function N(){d.value="",u=null,h.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),n.classList.add("hidden"),a.disabled=!0,f("請輸入設定並上傳檔案","")}function w(e,o){const s=S(p.value||"G"),r=S(t.value||"F"),l={男:0,女:0,"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0};for(let v=1;v<e.length;v++){const m=e[v];if(s!==-1&&m[s]!==void 0){const c=m[s].toString().trim();c==="男"?l.男++:c==="女"&&l.女++}if(r!==-1&&m[r]!==void 0){const c=parseInt(m[r]);isNaN(c)||(c<=49?l["<= 49"]++:c>=50&&c<=64?l["50 >= && <= 64"]++:c>=65&&c<=74?l["65 >= && <= 74"]++:c>=75&&c<=84?l["75 >= && <= 84"]++:c>=85&&l["85 >="]++)}}D(l),h.classList.remove("hidden"),h.querySelector(".file-name").textContent=o,document.querySelector(".upload-content").classList.add("hidden"),n.classList.remove("hidden"),f("檔案已就緒，請確認統計結果","success"),B()}function D(e){O.innerHTML=`
            <div class="stat-item"><span>男</span> <span class="stat-value">${e.男}</span></div>
            <div class="stat-item"><span>女</span> <span class="stat-value">${e.女}</span></div>
        `,b.innerHTML=`
            <div class="stat-item"><span><= 49</span> <span class="stat-value">${e["<= 49"]}</span></div>
            <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${e["50 >= && <= 64"]}</span></div>
            <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${e["65 >= && <= 74"]}</span></div>
            <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${e["75 >= && <= 84"]}</span></div>
            <div class="stat-item"><span>>= 85</span> <span class="stat-value">${e["85 >="]}</span></div>
        `,a.dataset.stats=JSON.stringify(e)}function B(){const e=g.value.length>=5,o=p.value.trim().length>0,s=t.value.trim().length>0,r=!!u;a.disabled=!(e&&o&&s&&r)}[g,p,t].forEach(e=>{e.oninput=()=>{B(),u&&L()}}),a.onclick=async()=>{const e=JSON.parse(a.dataset.stats),o=g.value;E(!0),f("正在同步至 Google Sheet...","success");try{await fetch(x,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:o,data:e})}),f("同步完成！請檢查您的 Google Sheet","success")}catch(s){console.error(s),f("同步失敗: "+s.message,"error")}finally{E(!1)}};function E(e){a.disabled=e,a.querySelector(".btn-text").classList.toggle("hidden",e),a.querySelector(".loader").classList.toggle("hidden",!e)}function f(e,o){y.textContent=e,y.className="status-message "+o}});
