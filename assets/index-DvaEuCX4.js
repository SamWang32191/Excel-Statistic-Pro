(function(){const f=document.createElement("link").relList;if(f&&f.supports&&f.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))p(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const g of s.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&p(g)}).observe(document,{childList:!0,subtree:!0});function m(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function p(t){if(t.ep)return;t.ep=!0;const s=m(t);fetch(t.href,s)}})();document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("dropZone"),f=document.getElementById("fileInput"),m=document.getElementById("citySelect"),p=document.getElementById("rocDate"),t=document.getElementById("genderCol"),s=document.getElementById("ageCol"),g=document.getElementById("previewSection"),d=document.getElementById("uploadBtn"),L=document.getElementById("statusMessage"),y=document.getElementById("fileInfo"),O=document.getElementById("removeFile"),b=document.getElementById("genderStats"),x=document.getElementById("ageStats"),N="https://script.google.com/macros/s/AKfycbwfeDQPIplOO7e6uqxacl15bFoQ470bcGvufeXXFEQoAER7yjDBPrlI1WllKS8vrh2k/exec";let u=null;function E(e){if(!e)return-1;let o=0;const n=e.toUpperCase();for(let a=0;a<n.length;a++)o=o*26+n.charCodeAt(a)-64;return o-1}i.onclick=()=>f.click(),i.ondragover=e=>{e.preventDefault(),i.classList.add("dragover")},i.ondragleave=()=>i.classList.remove("dragover"),i.ondrop=e=>{e.preventDefault(),i.classList.remove("dragover"),e.dataTransfer.files.length&&B(e.dataTransfer.files[0])},f.onchange=e=>{e.target.files.length&&B(e.target.files[0])},O.onclick=e=>{e.stopPropagation(),w()};function B(e){if(!e.name.match(/\.(xlsx|xls)$/)){l("不支援的檔案格式","error");return}u=e,S()}function S(){if(!u)return;const e=new FileReader;e.onload=o=>{try{const n=new Uint8Array(o.target.result),a=XLSX.read(n,{type:"array"}),r=a.SheetNames[0],h=a.Sheets[r],v=XLSX.utils.sheet_to_json(h,{header:1});D(v,u.name)}catch(n){console.error(n),l("讀取檔案失敗","error")}},e.readAsArrayBuffer(u)}function w(){f.value="",u=null,y.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),g.classList.add("hidden"),d.disabled=!0,l("請選擇縣市、輸入月份並上傳檔案","")}function D(e,o){const n=E(t.value||"G"),a=E(s.value||"F"),r={男:0,女:0,"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0};for(let h=1;h<e.length;h++){const v=e[h];if(n!==-1&&v[n]!==void 0){const c=v[n].toString().trim();c==="男"?r.男++:c==="女"&&r.女++}if(a!==-1&&v[a]!==void 0){const c=parseInt(v[a]);isNaN(c)||(c<=49?r["<= 49"]++:c>=50&&c<=64?r["50 >= && <= 64"]++:c>=65&&c<=74?r["65 >= && <= 74"]++:c>=75&&c<=84?r["75 >= && <= 84"]++:c>=85&&r["85 >="]++)}}A(r),y.classList.remove("hidden"),y.querySelector(".file-name").textContent=o,document.querySelector(".upload-content").classList.add("hidden"),g.classList.remove("hidden"),l("檔案已就緒，請確認統計結果","success"),I()}function A(e){b.innerHTML=`
            <div class="stat-item"><span>男</span> <span class="stat-value">${e.男}</span></div>
            <div class="stat-item"><span>女</span> <span class="stat-value">${e.女}</span></div>
        `,x.innerHTML=`
            <div class="stat-item"><span><= 49</span> <span class="stat-value">${e["<= 49"]}</span></div>
            <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${e["50 >= && <= 64"]}</span></div>
            <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${e["65 >= && <= 74"]}</span></div>
            <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${e["75 >= && <= 84"]}</span></div>
            <div class="stat-item"><span>>= 85</span> <span class="stat-value">${e["85 >="]}</span></div>
        `,d.dataset.stats=JSON.stringify(e)}function I(){const e=m.value!=="",o=p.value.length>=2,n=t.value.trim().length>0,a=s.value.trim().length>0,r=!!u;d.disabled=!(e&&o&&n&&a&&r)}[m,p,t,s].forEach(e=>{e.addEventListener("input",()=>{I(),u&&S()}),e.addEventListener("change",()=>{I(),u&&S()})}),d.onclick=async()=>{if(!m.value){l("請選擇縣市","error");return}if(p.value.length<2){l("請輸入月份","error");return}const e=JSON.parse(d.dataset.stats),o=m.value+p.value;C(!0),l("正在同步至 Google Sheet...","success");try{await fetch(N,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:o,data:e})}),l("同步完成！請檢查您的 Google Sheet","success")}catch(n){console.error(n),l("同步失敗: "+n.message,"error")}finally{C(!1)}};function C(e){d.disabled=e,d.querySelector(".btn-text").classList.toggle("hidden",e),d.querySelector(".loader").classList.toggle("hidden",!e)}function l(e,o){L.textContent=e,L.className="status-message "+o}});
