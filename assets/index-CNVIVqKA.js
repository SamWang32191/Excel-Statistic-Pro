(function(){const p=document.createElement("link").relList;if(p&&p.supports&&p.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))l(s);new MutationObserver(s=>{for(const v of s)if(v.type==="childList")for(const y of v.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&l(y)}).observe(document,{childList:!0,subtree:!0});function m(s){const v={};return s.integrity&&(v.integrity=s.integrity),s.referrerPolicy&&(v.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?v.credentials="include":s.crossOrigin==="anonymous"?v.credentials="omit":v.credentials="same-origin",v}function l(s){if(s.ep)return;s.ep=!0;const v=m(s);fetch(s.href,v)}})();function le(g){let p=null,m=null;return g.SheetNames.forEach(l=>{l.includes("台北")?p=l:l.includes("新北")&&(m=l)}),{taipeiSheetName:p,newTaipeiSheetName:m}}function T(g){if(!g)return-1;let p=0;const m=g.toUpperCase();for(let l=0;l<m.length;l++)p=p*26+m.charCodeAt(l)-64;return p-1}function F(g,p,m=!1,l=null){const s={gender:{男:0,女:0},age:{"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0},living:{},cms:{}};if(!g||g.length===0)return s;const v=T(p.gender||""),y=T(p.age||""),x=T(p.living||""),$=T(p.cms||""),A=m?T(p.category||""):-1;for(let D=1;D<g.length;D++){const h=g[D];if(m&&A!==-1){const n=(h[A]||"").toString().trim();if(l){if(n!==l)continue}else if(n!=="老福"&&n!=="身障")continue}if(v!==-1&&h[v]!==void 0){const n=h[v].toString().trim();n==="男"?s.gender.男++:n==="女"&&s.gender.女++}if(y!==-1&&h[y]!==void 0){const n=parseInt(h[y]);isNaN(n)||(n<=49?s.age["<= 49"]++:n>=50&&n<=64?s.age["50 >= && <= 64"]++:n>=65&&n<=74?s.age["65 >= && <= 74"]++:n>=75&&n<=84?s.age["75 >= && <= 84"]++:n>=85&&s.age["85 >="]++)}if(x!==-1&&h[x]!==void 0){let n=h[x].toString().trim();n&&(n==="其他類型居住狀況"&&(n="其他"),s.living[n]=(s.living[n]||0)+1)}if($!==-1&&h[$]!==void 0){const n=h[$].toString().trim();n&&(s.cms[n]=(s.cms[n]||0)+1)}}return s}document.addEventListener("DOMContentLoaded",()=>{const g=document.getElementById("dropZone"),p=document.getElementById("fileInput"),m=document.getElementById("citySelect"),l=document.getElementById("rocDate"),s=document.getElementById("tpCategoryCol"),v=document.getElementById("tpGenderCol"),y=document.getElementById("tpAgeCol"),x=document.getElementById("tpLivingCol"),$=document.getElementById("tpCmsCol"),A=document.getElementById("ntGenderCol"),D=document.getElementById("ntAgeCol"),h=document.getElementById("ntLivingCol"),n=document.getElementById("ntCmsCol"),H=document.getElementById("previewSection"),P=document.getElementById("previewContainer"),I=document.getElementById("uploadBtn"),_=document.getElementById("statusMessage"),R=document.getElementById("fileInfo"),Y=document.getElementById("removeFile"),ee=document.getElementById("caseListCols"),te=document.getElementById("serviceRegisterCols"),J=document.getElementById("cityInputGroup"),se=document.getElementById("tpServiceCategoryGroup"),U=document.getElementById("headerRowIdx"),M=document.getElementById("districtCol"),k=document.getElementById("categoryCol"),X=document.getElementById("subsidyCol"),z=document.querySelectorAll(".btn-switch"),q=()=>{const e=C==="service"&&m.value==="台北";se.classList.toggle("hidden",!e)},K="https://script.google.com/macros/s/AKfycbwfeDQPIplOO7e6uqxacl15bFoQ470bcGvufeXXFEQoAER7yjDBPrlI1WllKS8vrh2k/exec";let E=null,C="case";J.classList.toggle("hidden",C==="case"),q(),z.forEach(e=>{e.onclick=()=>{e.dataset.mode!==C&&(z.forEach(i=>i.classList.remove("active")),e.classList.add("active"),C=e.dataset.mode,ee.classList.toggle("hidden",C!=="case"),te.classList.toggle("hidden",C!=="service"),J.classList.toggle("hidden",C==="case"),q(),W())}}),m.addEventListener("change",()=>{q(),G(),E&&j()}),g.onclick=()=>p.click(),g.ondragover=e=>{e.preventDefault(),g.classList.add("dragover")},g.ondragleave=()=>g.classList.remove("dragover"),g.ondrop=e=>{e.preventDefault(),g.classList.remove("dragover"),e.dataTransfer.files.length&&Q(e.dataTransfer.files[0])},p.onchange=e=>{e.target.files.length&&Q(e.target.files[0])},Y.onclick=e=>{e.stopPropagation(),W()};function Q(e){if(!e.name.match(/\.(xlsx|xls)$/)){w("不支援的檔案格式","error");return}E=e,j()}function j(){if(!E)return;const e=new FileReader;e.onload=i=>{try{const o=new Uint8Array(i.target.result),c=XLSX.read(o,{type:"array"});if(C==="case"){const{taipeiSheetName:d,newTaipeiSheetName:t}=le(c),u={taipei:d?XLSX.utils.sheet_to_json(c.Sheets[d],{header:1}):null,newTaipei:t?XLSX.utils.sheet_to_json(c.Sheets[t],{header:1}):null};ne(u,E.name)}else{const d=c.SheetNames[0],t=c.Sheets[d],u=XLSX.utils.sheet_to_json(t,{header:1});ae(u,E.name)}}catch(o){console.error(o),w("讀取檔案失敗: "+o.message,"error")}},e.readAsArrayBuffer(E)}function W(){p.value="",E=null,R.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),H.classList.add("hidden"),I.disabled=!0,w("請選擇縣市、輸入月份並上傳檔案","")}function ne(e,i){const o=[],c=()=>({gender:{男:0,女:0},age:{"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0},living:{},cms:{}});if(e.newTaipei&&e.newTaipei.length>0){const d=F(e.newTaipei,{gender:A.value,age:D.value,living:h.value,cms:n.value});o.push({title:"新北",sheetName:`新北${l.value}`,stats:d,hasData:!0})}else o.push({title:"新北",sheetName:`新北${l.value}`,stats:c(),hasData:!1});if(e.taipei&&e.taipei.length>0){const d=F(e.taipei,{category:s.value,gender:v.value,age:y.value,living:x.value,cms:$.value},!0,"老福");o.push({title:"台北老福",sheetName:`台北老福${l.value}`,stats:d,hasData:d.gender.男+d.gender.女>0});const t=F(e.taipei,{category:s.value,gender:v.value,age:y.value,living:x.value,cms:$.value},!0,"身障");o.push({title:"台北身障",sheetName:`台北身障${l.value}`,stats:t,hasData:t.gender.男+t.gender.女>0})}else o.push({title:"台北老福",sheetName:`台北老福${l.value}`,stats:c(),hasData:!1}),o.push({title:"台北身障",sheetName:`台北身障${l.value}`,stats:c(),hasData:!1});ie(o),Z(i)}function ae(e,i){const o=parseInt(U.value||"5"),c=T(M.value||"U"),d=T(k.value||"G"),t=T(X.value||"O"),u={},r={},f={};for(let b=o;b<e.length;b++){const S=e[b];if(c!==-1&&S[c]!==void 0){const a=S[c].toString().trim();a&&(u[a]=(u[a]||0)+1)}if(d!==-1&&S[d]!==void 0){const a=S[d].toString().trim();a&&(r[a]=(r[a]||0)+1)}if(t!==-1&&S[t]!==void 0){const a=S[t].toString().trim();a&&(f[a]=(f[a]||0)+1)}}oe(u,r,f),Z(i)}function Z(e){R.classList.remove("hidden"),R.querySelector(".file-name").textContent=e,document.querySelector(".upload-content").classList.add("hidden"),H.classList.remove("hidden"),w("檔案已就緒，請確認統計結果","success"),G()}function ie(e){P.innerHTML="",serviceStatsGrid.classList.add("hidden"),P.classList.remove("hidden");const i=[];e.forEach(o=>{const{title:c,sheetName:d,stats:t,hasData:u}=o,r=document.createElement("div");if(r.className="preview-group",!u)r.innerHTML=`
                    <div class="preview-group-header">
                        <span class="preview-group-title">${c}</span>
                        <span class="preview-group-badge" style="background: rgba(100,116,139, 0.2); color: #94a3b8;">無資料</span>
                    </div>
                    <div class="stats-grid" style="opacity: 0.5;">
                        <div class="stat-card"><div class="stat-label">狀態</div><div class="stat-values">無資料</div></div>
                    </div>
                `;else{const f=["獨居","獨居(兩老)","與家人或其他人同住","與朋友同住","其他"],b=f.filter(L=>t.living[L]!==void 0).map(L=>`<div class="stat-item"><span>${L}</span> <span class="stat-value">${t.living[L]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>',S=["1","2","3","4","5","6","7","8"],a=Object.keys(t.cms).filter(L=>!S.includes(L)).sort(),B=S.concat(a),O=B.filter(L=>t.cms[L]!==void 0).map(L=>`<div class="stat-item"><span>${L}</span> <span class="stat-value">${t.cms[L]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';r.innerHTML=`
                    <div class="preview-group-header">
                        <span class="preview-group-title">${c}</span>
                        <span class="preview-group-badge">${d}</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">性別統計</div>
                            <div class="stat-values">
                                <div class="stat-item"><span>男</span> <span class="stat-value">${t.gender.男}</span></div>
                                <div class="stat-item"><span>女</span> <span class="stat-value">${t.gender.女}</span></div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">年齡分佈</div>
                            <div class="stat-values">
                                <div class="stat-item"><span><= 49</span> <span class="stat-value">${t.age["<= 49"]}</span></div>
                                <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${t.age["50 >= && <= 64"]}</span></div>
                                <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${t.age["65 >= && <= 74"]}</span></div>
                                <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${t.age["75 >= && <= 84"]}</span></div>
                                <div class="stat-item"><span>>= 85</span> <span class="stat-value">${t.age["85 >="]}</span></div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">居住狀況</div>
                            <div class="stat-values">${b}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">CMS 等級</div>
                            <div class="stat-values">${O}</div>
                        </div>
                    </div>
                `;const N=ce(t.gender,t.living,t.cms,f,B,t.age);i.push({sheetName:d,rows:N})}P.appendChild(r)}),I.dataset.outputPayload=JSON.stringify(i),i.length===0&&(w("警告：所有縣市皆無資料","error"),I.disabled=!0)}function oe(e,i,o){caseStatsGrid.classList.add("hidden"),serviceStatsGrid.classList.remove("hidden");const c=["三重區","蘆洲區","五股區","板橋區","土城區","新莊區","中和區","永和區","樹林區","泰山區","新店區"],d=["松山區","信義區","大安區","中山區","中正區","大同區","萬華區","文山區","南港區","內湖區","士林區","北投區"],t=m.value==="台北"?d:c,u=Object.keys(e).sort((a,B)=>{const O=t.indexOf(a),N=t.indexOf(B);return O!==-1&&N!==-1?O-N:O!==-1?-1:N!==-1?1:a.localeCompare(B,"zh-hant")});districtStatsDiv.innerHTML=u.map(a=>`<div class="stat-item"><span>${a}</span> <span class="stat-value">${e[a]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const r=Object.keys(i).sort((a,B)=>a.localeCompare(B,"zh-hant"));categoryStatsDiv.innerHTML=r.map(a=>`<div class="stat-item"><span>${a}</span> <span class="stat-value">${i[a]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const f=["100%","95%","84%"],b=Object.keys(o).sort((a,B)=>{const O=f.indexOf(a),N=f.indexOf(B);return O!==-1&&N!==-1?O-N:O!==-1?-1:N!==-1?1:a.localeCompare(B)});subsidyStatsDiv.innerHTML=b.map(a=>`<div class="stat-item"><span>${a}</span> <span class="stat-value">${o[a]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const S=re(e,u,i,r,o,b);I.dataset.outputRows=JSON.stringify(S)}function ce(e,i,o,c,d,t){const u=t||e,r=[["【性別統計】",""],["男",e.男||0],["女",e.女||0],["",""]];return r.push(["【年齡分佈】",""],["<= 49",u["<= 49"]||0],["50 >= && <= 64",u["50 >= && <= 64"]||0],["65 >= && <= 74",u["65 >= && <= 74"]||0],["75 >= && <= 84",u["75 >= && <= 84"]||0],["85 >=",u["85 >="]||0],["",""]),r.push(["【居住狀況】",""]),c.forEach(f=>{i[f]!==void 0&&r.push([f,i[f]])}),r.push(["",""],["【CMS 等級】",""]),d.forEach(f=>{o[f]!==void 0&&r.push([f,o[f]])}),r}function re(e,i,o,c,d,t){const u=[["【行政區統計】",""]];return i.forEach(r=>u.push([r,e[r]])),u.push(["",""],["【服務項目類別】",""]),c.forEach(r=>u.push([r,o[r]])),u.push(["",""],["【補助比率】",""]),t.forEach(r=>u.push([r,d[r]])),u}function G(){const e=C==="case"||m.value!=="",i=l.value.length>=2,o=!!E;let c=!1;if(C==="case"){const d=s.value.trim()&&v.value.trim()&&y.value.trim()&&x.value.trim()&&$.value.trim(),t=A.value.trim()&&D.value.trim()&&h.value.trim()&&n.value.trim();c=d&&t}else c=M.value.trim()&&k.value.trim()&&X.value.trim();I.disabled=!(e&&i&&c&&o)}[m,l,s,v,y,x,$,A,D,h,n,M,k,X,U].forEach(e=>{e.addEventListener("input",()=>{G(),E&&j()}),e.addEventListener("change",()=>{G(),E&&j()})}),I.onclick=async()=>{if(C==="service"&&!m.value){w("請選擇縣市","error");return}if(l.value.length<2){w("請輸入月份","error");return}V(!0),w("正在同步至 Google Sheet...","success");try{if(C==="case"){const e=JSON.parse(I.dataset.outputPayload||"[]");for(const i of e)await fetch(K,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}else{const e=JSON.parse(I.dataset.outputRows||"[]");let i=m.value;m.value==="台北"&&(i=`台北${document.querySelector('input[name="tpServiceCategory"]:checked').value}`);const o=i+l.value;await fetch(K,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:o,rows:e})})}w("同步完成！請檢查您的 Google Sheet","success")}catch(e){console.error(e),w("同步失敗: "+e.message,"error")}finally{V(!1)}};function V(e){I.disabled=e,I.querySelector(".btn-text").classList.toggle("hidden",e),I.querySelector(".loader").classList.toggle("hidden",!e)}function w(e,i){_.textContent=e,_.className="status-message "+i}});
