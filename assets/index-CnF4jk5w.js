(function(){const y=document.createElement("link").relList;if(y&&y.supports&&y.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))S(d);new MutationObserver(d=>{for(const m of d)if(m.type==="childList")for(const C of m.addedNodes)C.tagName==="LINK"&&C.rel==="modulepreload"&&S(C)}).observe(document,{childList:!0,subtree:!0});function I(d){const m={};return d.integrity&&(m.integrity=d.integrity),d.referrerPolicy&&(m.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?m.credentials="include":d.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function S(d){if(d.ep)return;d.ep=!0;const m=I(d);fetch(d.href,m)}})();document.addEventListener("DOMContentLoaded",()=>{const g=document.getElementById("dropZone"),y=document.getElementById("fileInput"),I=document.getElementById("citySelect"),S=document.getElementById("rocDate"),d=document.getElementById("genderCol"),m=document.getElementById("ageCol"),C=document.getElementById("livingCol"),w=document.getElementById("cmsCol"),N=document.getElementById("previewSection"),v=document.getElementById("uploadBtn"),A=document.getElementById("statusMessage"),R=document.getElementById("fileInfo"),J=document.getElementById("removeFile"),U=document.getElementById("genderStats"),z=document.getElementById("ageStats"),K=document.getElementById("livingStats"),Q=document.getElementById("cmsStats"),_=document.getElementById("caseListCols"),Z=document.getElementById("serviceRegisterCols"),P=document.getElementById("headerRowIdx"),$=document.getElementById("districtCol"),D=document.getElementById("categoryCol"),T=document.getElementById("subsidyCol"),b=document.querySelectorAll(".btn-switch"),F=document.getElementById("caseStatsGrid"),G=document.getElementById("serviceStatsGrid"),W=document.getElementById("districtStats"),V=document.getElementById("categoryStats"),Y=document.getElementById("subsidyStats"),ee="https://script.google.com/macros/s/AKfycbwfeDQPIplOO7e6uqxacl15bFoQ470bcGvufeXXFEQoAER7yjDBPrlI1WllKS8vrh2k/exec";let h=null,x="case";b.forEach(e=>{e.onclick=()=>{e.dataset.mode!==x&&(b.forEach(n=>n.classList.remove("active")),e.classList.add("active"),x=e.dataset.mode,_.classList.toggle("hidden",x!=="case"),Z.classList.toggle("hidden",x!=="service"),q())}});function E(e){if(!e)return-1;let n=0;const o=e.toUpperCase();for(let i=0;i<o.length;i++)n=n*26+o.charCodeAt(i)-64;return n-1}g.onclick=()=>y.click(),g.ondragover=e=>{e.preventDefault(),g.classList.add("dragover")},g.ondragleave=()=>g.classList.remove("dragover"),g.ondrop=e=>{e.preventDefault(),g.classList.remove("dragover"),e.dataTransfer.files.length&&k(e.dataTransfer.files[0])},y.onchange=e=>{e.target.files.length&&k(e.target.files[0])},J.onclick=e=>{e.stopPropagation(),q()};function k(e){if(!e.name.match(/\.(xlsx|xls)$/)){f("不支援的檔案格式","error");return}h=e,j()}function j(){if(!h)return;const e=new FileReader;e.onload=n=>{try{const o=new Uint8Array(n.target.result),i=XLSX.read(o,{type:"array"}),l=i.SheetNames[0],a=i.Sheets[l],s=XLSX.utils.sheet_to_json(a,{header:1});te(s,h.name)}catch(o){console.error(o),f("讀取檔案失敗","error")}},e.readAsArrayBuffer(h)}function q(){y.value="",h=null,R.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),N.classList.add("hidden"),v.disabled=!0,f("請選擇縣市、輸入月份並上傳檔案","")}function te(e,n){x==="case"?se(e,n):ne(e,n)}function se(e,n){const o=E(d.value||"G"),i=E(m.value||"F"),l=E(C.value||"O"),a=E(w.value||"J"),s={男:0,女:0,"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0},r={},c={};for(let p=1;p<e.length;p++){const u=e[p];if(o!==-1&&u[o]!==void 0){const t=u[o].toString().trim();t==="男"?s.男++:t==="女"&&s.女++}if(i!==-1&&u[i]!==void 0){const t=parseInt(u[i]);isNaN(t)||(t<=49?s["<= 49"]++:t>=50&&t<=64?s["50 >= && <= 64"]++:t>=65&&t<=74?s["65 >= && <= 74"]++:t>=75&&t<=84?s["75 >= && <= 84"]++:t>=85&&s["85 >="]++)}if(l!==-1&&u[l]!==void 0){let t=u[l].toString().trim();t&&(t==="其他類型居住狀況"&&(t="其他"),r[t]=(r[t]||0)+1)}if(a!==-1&&u[a]!==void 0){const t=u[a].toString().trim();t&&(c[t]=(c[t]||0)+1)}}oe(s,r,c),H(n)}function ne(e,n){const o=parseInt(P.value||"5"),i=E($.value||"U"),l=E(D.value||"G"),a=E(T.value||"O"),s={},r={},c={};for(let p=o;p<e.length;p++){const u=e[p];if(i!==-1&&u[i]!==void 0){const t=u[i].toString().trim();t&&(s[t]=(s[t]||0)+1)}if(l!==-1&&u[l]!==void 0){const t=u[l].toString().trim();t&&(r[t]=(r[t]||0)+1)}if(a!==-1&&u[a]!==void 0){const t=u[a].toString().trim();t&&(c[t]=(c[t]||0)+1)}}ie(s,r,c),H(n)}function H(e){R.classList.remove("hidden"),R.querySelector(".file-name").textContent=e,document.querySelector(".upload-content").classList.add("hidden"),N.classList.remove("hidden"),f("檔案已就緒，請確認統計結果","success"),M()}function oe(e,n,o){F.classList.remove("hidden"),G.classList.add("hidden"),U.innerHTML=`
            <div class="stat-item"><span>男</span> <span class="stat-value">${e.男}</span></div>
            <div class="stat-item"><span>女</span> <span class="stat-value">${e.女}</span></div>
        `,z.innerHTML=`
            <div class="stat-item"><span><= 49</span> <span class="stat-value">${e["<= 49"]}</span></div>
            <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${e["50 >= && <= 64"]}</span></div>
            <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${e["65 >= && <= 74"]}</span></div>
            <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${e["75 >= && <= 84"]}</span></div>
            <div class="stat-item"><span>>= 85</span> <span class="stat-value">${e["85 >="]}</span></div>
        `;const i=["獨居","獨居(兩老)","與家人或其他人同住","與朋友同住","其他"];K.innerHTML=i.filter(c=>n[c]!==void 0).map(c=>`<div class="stat-item"><span>${c}</span> <span class="stat-value">${n[c]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const l=["1","2","3","4","5","6","7","8"],a=Object.keys(o).filter(c=>!l.includes(c)).sort(),s=l.concat(a);Q.innerHTML=s.filter(c=>o[c]!==void 0).map(c=>`<div class="stat-item"><span>${c}</span> <span class="stat-value">${o[c]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const r=ae(e,n,o,i,s);v.dataset.outputRows=JSON.stringify(r)}function ie(e,n,o){F.classList.add("hidden"),G.classList.remove("hidden");const i=["三重區","蘆洲區","五股區","板橋區","土城區","新莊區","中和區","永和區","樹林區","泰山區","新店區"],l=["松山區","信義區","大安區","中山區","中正區","大同區","萬華區","文山區","南港區","內湖區","士林區","北投區"],a=I.value==="台北"?l:i,s=Object.keys(e).sort((t,L)=>{const B=a.indexOf(t),O=a.indexOf(L);return B!==-1&&O!==-1?B-O:B!==-1?-1:O!==-1?1:t.localeCompare(L,"zh-hant")});W.innerHTML=s.map(t=>`<div class="stat-item"><span>${t}</span> <span class="stat-value">${e[t]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const r=Object.keys(n).sort((t,L)=>t.localeCompare(L,"zh-hant"));V.innerHTML=r.map(t=>`<div class="stat-item"><span>${t}</span> <span class="stat-value">${n[t]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const c=["100%","95%","84%"],p=Object.keys(o).sort((t,L)=>{const B=c.indexOf(t),O=c.indexOf(L);return B!==-1&&O!==-1?B-O:B!==-1?-1:O!==-1?1:t.localeCompare(L)});Y.innerHTML=p.map(t=>`<div class="stat-item"><span>${t}</span> <span class="stat-value">${o[t]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const u=ce(e,s,n,r,o,p);v.dataset.outputRows=JSON.stringify(u)}function ae(e,n,o,i,l){const a=[["【性別統計】",""],["男",e.男||0],["女",e.女||0],["",""]];return a.push(["【年齡分佈】",""],["<= 49",e["<= 49"]||0],["50 >= && <= 64",e["50 >= && <= 64"]||0],["65 >= && <= 74",e["65 >= && <= 74"]||0],["75 >= && <= 84",e["75 >= && <= 84"]||0],["85 >=",e["85 >="]||0],["",""]),a.push(["【居住狀況】",""]),i.forEach(s=>{n[s]!==void 0&&a.push([s,n[s]])}),a.push(["",""],["【CMS 等級】",""]),l.forEach(s=>{o[s]!==void 0&&a.push([s,o[s]])}),a}function ce(e,n,o,i,l,a){const s=[["【行政區統計】",""]];return n.forEach(r=>s.push([r,e[r]])),s.push(["",""],["【服務項目類別】",""]),i.forEach(r=>s.push([r,o[r]])),s.push(["",""],["【補助比率】",""]),a.forEach(r=>s.push([r,l[r]])),s}function M(){const e=I.value!=="",n=S.value.length>=2,o=!!h;let i=!1;x==="case"?i=d.value.trim()&&m.value.trim()&&C.value.trim()&&w.value.trim():i=$.value.trim()&&D.value.trim()&&T.value.trim(),v.disabled=!(e&&n&&i&&o)}[I,S,d,m,C,w,$,D,T,P].forEach(e=>{e.addEventListener("input",()=>{M(),h&&j()}),e.addEventListener("change",()=>{M(),h&&j()})}),v.onclick=async()=>{if(!I.value){f("請選擇縣市","error");return}if(S.value.length<2){f("請輸入月份","error");return}const e=JSON.parse(v.dataset.outputRows||"[]"),n=I.value+S.value;X(!0),f("正在同步至 Google Sheet...","success");try{await fetch(ee,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:n,rows:e})}),f("同步完成！請檢查您的 Google Sheet","success")}catch(o){console.error(o),f("同步失敗: "+o.message,"error")}finally{X(!1)}};function X(e){v.disabled=e,v.querySelector(".btn-text").classList.toggle("hidden",e),v.querySelector(".loader").classList.toggle("hidden",!e)}function f(e,n){A.textContent=e,A.className="status-message "+n}});
