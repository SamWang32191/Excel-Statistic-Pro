(function(){const g=document.createElement("link").relList;if(g&&g.supports&&g.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))p(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const m of o.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&p(m)}).observe(document,{childList:!0,subtree:!0});function v(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function p(t){if(t.ep)return;t.ep=!0;const o=v(t);fetch(t.href,o)}})();document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("dropZone"),g=document.getElementById("fileInput"),v=document.getElementById("citySelect"),p=document.getElementById("rocDate"),t=document.getElementById("genderCol"),o=document.getElementById("ageCol"),m=document.getElementById("livingCol"),C=document.getElementById("previewSection"),c=document.getElementById("uploadBtn"),O=document.getElementById("statusMessage"),S=document.getElementById("fileInfo"),D=document.getElementById("removeFile"),b=document.getElementById("genderStats"),w=document.getElementById("ageStats"),A=document.getElementById("livingStats"),F="https://script.google.com/macros/s/AKfycbwfeDQPIplOO7e6uqxacl15bFoQ470bcGvufeXXFEQoAER7yjDBPrlI1WllKS8vrh2k/exec";let f=null;function I(e){if(!e)return-1;let n=0;const r=e.toUpperCase();for(let a=0;a<r.length;a++)n=n*26+r.charCodeAt(a)-64;return n-1}u.onclick=()=>g.click(),u.ondragover=e=>{e.preventDefault(),u.classList.add("dragover")},u.ondragleave=()=>u.classList.remove("dragover"),u.ondrop=e=>{e.preventDefault(),u.classList.remove("dragover"),e.dataTransfer.files.length&&N(e.dataTransfer.files[0])},g.onchange=e=>{e.target.files.length&&N(e.target.files[0])},D.onclick=e=>{e.stopPropagation(),P()};function N(e){if(!e.name.match(/\.(xlsx|xls)$/)){d("不支援的檔案格式","error");return}f=e,L()}function L(){if(!f)return;const e=new FileReader;e.onload=n=>{try{const r=new Uint8Array(n.target.result),a=XLSX.read(r,{type:"array"}),i=a.SheetNames[0],l=a.Sheets[i],y=XLSX.utils.sheet_to_json(l,{header:1});$(y,f.name)}catch(r){console.error(r),d("讀取檔案失敗","error")}},e.readAsArrayBuffer(f)}function P(){g.value="",f=null,S.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),C.classList.add("hidden"),c.disabled=!0,d("請選擇縣市、輸入月份並上傳檔案","")}function $(e,n){const r=I(t.value||"G"),a=I(o.value||"F"),i=I(m.value||"O"),l={男:0,女:0,"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0},y={};for(let B=1;B<e.length;B++){const h=e[B];if(r!==-1&&h[r]!==void 0){const s=h[r].toString().trim();s==="男"?l.男++:s==="女"&&l.女++}if(a!==-1&&h[a]!==void 0){const s=parseInt(h[a]);isNaN(s)||(s<=49?l["<= 49"]++:s>=50&&s<=64?l["50 >= && <= 64"]++:s>=65&&s<=74?l["65 >= && <= 74"]++:s>=75&&s<=84?l["75 >= && <= 84"]++:s>=85&&l["85 >="]++)}if(i!==-1&&h[i]!==void 0){let s=h[i].toString().trim();s&&(s==="其他類型居住狀況"&&(s="其他"),y[s]=(y[s]||0)+1)}}T(l,y),S.classList.remove("hidden"),S.querySelector(".file-name").textContent=n,document.querySelector(".upload-content").classList.add("hidden"),C.classList.remove("hidden"),d("檔案已就緒，請確認統計結果","success"),E()}function T(e,n){b.innerHTML=`
            <div class="stat-item"><span>男</span> <span class="stat-value">${e.男}</span></div>
            <div class="stat-item"><span>女</span> <span class="stat-value">${e.女}</span></div>
        `,w.innerHTML=`
            <div class="stat-item"><span><= 49</span> <span class="stat-value">${e["<= 49"]}</span></div>
            <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${e["50 >= && <= 64"]}</span></div>
            <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${e["65 >= && <= 74"]}</span></div>
            <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${e["75 >= && <= 84"]}</span></div>
            <div class="stat-item"><span>>= 85</span> <span class="stat-value">${e["85 >="]}</span></div>
        `;const a=["獨居","獨居(兩老)","與家人或其他人同住","與朋友同住","其他"].filter(i=>n[i]!==void 0).map(i=>`<div class="stat-item"><span>${i}</span> <span class="stat-value">${n[i]}</span></div>`).join("");A.innerHTML=a||'<div class="stat-item"><span>無資料</span></div>',c.dataset.stats=JSON.stringify(e),c.dataset.livingStats=JSON.stringify(n)}function E(){const e=v.value!=="",n=p.value.length>=2,r=t.value.trim().length>0,a=o.value.trim().length>0,i=m.value.trim().length>0,l=!!f;c.disabled=!(e&&n&&r&&a&&i&&l)}[v,p,t,o,m].forEach(e=>{e.addEventListener("input",()=>{E(),f&&L()}),e.addEventListener("change",()=>{E(),f&&L()})}),c.onclick=async()=>{if(!v.value){d("請選擇縣市","error");return}if(p.value.length<2){d("請輸入月份","error");return}const e=JSON.parse(c.dataset.stats),n=JSON.parse(c.dataset.livingStats||"{}"),r=v.value+p.value;x(!0),d("正在同步至 Google Sheet...","success");const a={...e,...n};try{await fetch(F,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:r,data:a})}),d("同步完成！請檢查您的 Google Sheet","success")}catch(i){console.error(i),d("同步失敗: "+i.message,"error")}finally{x(!1)}};function x(e){c.disabled=e,c.querySelector(".btn-text").classList.toggle("hidden",e),c.querySelector(".loader").classList.toggle("hidden",!e)}function d(e,n){O.textContent=e,O.className="status-message "+n}});
