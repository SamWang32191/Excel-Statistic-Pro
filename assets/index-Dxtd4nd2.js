(function(){const p=document.createElement("link").relList;if(p&&p.supports&&p.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))l(s);new MutationObserver(s=>{for(const v of s)if(v.type==="childList")for(const y of v.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&l(y)}).observe(document,{childList:!0,subtree:!0});function f(s){const v={};return s.integrity&&(v.integrity=s.integrity),s.referrerPolicy&&(v.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?v.credentials="include":s.crossOrigin==="anonymous"?v.credentials="omit":v.credentials="same-origin",v}function l(s){if(s.ep)return;s.ep=!0;const v=f(s);fetch(s.href,v)}})();function me(m){let p=null,f=null;return m.SheetNames.forEach(l=>{l.includes("台北")?p=l:l.includes("新北")&&(f=l)}),{taipeiSheetName:p,newTaipeiSheetName:f}}function D(m){if(!m)return-1;let p=0;const f=m.toUpperCase();for(let l=0;l<f.length;l++)p=p*26+f.charCodeAt(l)-64;return p-1}function J(m,p,f=!1,l=null){const s={gender:{男:0,女:0},age:{"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0},living:{},cms:{}};if(!m||m.length===0)return s;const v=D(p.gender||""),y=D(p.age||""),x=D(p.living||""),$=D(p.cms||""),R=f?D(p.category||""):-1;for(let A=1;A<m.length;A++){const h=m[A];if(f&&R!==-1){const a=(h[R]||"").toString().trim();if(l){if(a!==l)continue}else if(a!=="老福"&&a!=="身障")continue}if(v!==-1&&h[v]!==void 0){const a=h[v].toString().trim();a==="男"?s.gender.男++:a==="女"&&s.gender.女++}if(y!==-1&&h[y]!==void 0){const a=parseInt(h[y]);isNaN(a)||(a<=49?s.age["<= 49"]++:a>=50&&a<=64?s.age["50 >= && <= 64"]++:a>=65&&a<=74?s.age["65 >= && <= 74"]++:a>=75&&a<=84?s.age["75 >= && <= 84"]++:a>=85&&s.age["85 >="]++)}if(x!==-1&&h[x]!==void 0){let a=h[x].toString().trim();a&&(a==="其他類型居住狀況"&&(a="其他"),s.living[a]=(s.living[a]||0)+1)}if($!==-1&&h[$]!==void 0){const a=h[$].toString().trim();a&&(s.cms[a]=(s.cms[a]||0)+1)}}return s}document.addEventListener("DOMContentLoaded",()=>{const m=document.getElementById("dropZone"),p=document.getElementById("fileInput"),f=document.querySelectorAll(".btn-city"),l=document.getElementById("rocDate"),s=document.getElementById("tpCategoryCol"),v=document.getElementById("tpGenderCol"),y=document.getElementById("tpAgeCol"),x=document.getElementById("tpLivingCol"),$=document.getElementById("tpCmsCol"),R=document.getElementById("ntGenderCol"),A=document.getElementById("ntAgeCol"),h=document.getElementById("ntLivingCol"),a=document.getElementById("ntCmsCol"),U=document.getElementById("previewSection"),P=document.getElementById("previewContainer"),I=document.getElementById("uploadBtn"),z=document.getElementById("statusMessage"),k=document.getElementById("fileInfo"),te=document.getElementById("removeFile"),se=document.getElementById("caseListCols"),ne=document.getElementById("serviceRegisterCols"),K=document.getElementById("cityInputGroup"),ae=document.getElementById("tpServiceCategoryGroup"),Q=document.getElementById("headerRowIdx"),M=document.getElementById("districtCol"),q=document.getElementById("categoryCol"),X=document.getElementById("subsidyCol"),F=document.getElementById("serviceStatsGrid"),ie=document.getElementById("districtStats"),oe=document.getElementById("categoryStats"),ce=document.getElementById("subsidyStats"),W=document.querySelectorAll(".btn-switch"),H=()=>{const e=C==="service"&&T==="台北";ae.classList.toggle("hidden",!e)},Z="https://script.google.com/macros/s/AKfycbwfeDQPIplOO7e6uqxacl15bFoQ470bcGvufeXXFEQoAER7yjDBPrlI1WllKS8vrh2k/exec";let B=null,C="case",T="台北";K.classList.toggle("hidden",C==="case"),H(),W.forEach(e=>{e.onclick=()=>{e.dataset.mode!==C&&(W.forEach(n=>n.classList.remove("active")),e.classList.add("active"),C=e.dataset.mode,se.classList.toggle("hidden",C!=="case"),ne.classList.toggle("hidden",C!=="service"),K.classList.toggle("hidden",C==="case"),H(),j())}}),f.forEach(e=>{e.onclick=()=>{e.dataset.city!==T&&(f.forEach(n=>n.classList.remove("active")),e.classList.add("active"),T=e.dataset.city,H(),j(),G())}}),document.querySelectorAll('input[name="tpServiceCategory"]').forEach(e=>{e.addEventListener("change",()=>{j()})}),m.onclick=()=>p.click(),m.ondragover=e=>{e.preventDefault(),m.classList.add("dragover")},m.ondragleave=()=>m.classList.remove("dragover"),m.ondrop=e=>{e.preventDefault(),m.classList.remove("dragover"),e.dataTransfer.files.length&&V(e.dataTransfer.files[0])},p.onchange=e=>{e.target.files.length&&V(e.target.files[0])},te.onclick=e=>{e.stopPropagation(),j()};function V(e){if(!e.name.match(/\.(xlsx|xls)$/)){L("不支援的檔案格式","error");return}B=e,_()}function _(){if(!B)return;const e=new FileReader;e.onload=n=>{try{const o=new Uint8Array(n.target.result),r=XLSX.read(o,{type:"array"});if(C==="case"){const{taipeiSheetName:u,newTaipeiSheetName:t}=me(r),d={taipei:u?XLSX.utils.sheet_to_json(r.Sheets[u],{header:1}):null,newTaipei:t?XLSX.utils.sheet_to_json(r.Sheets[t],{header:1}):null};re(d,B.name)}else{const u=r.SheetNames[0],t=r.Sheets[u],d=XLSX.utils.sheet_to_json(t,{header:1});le(d,B.name)}}catch(o){console.error(o),L("讀取檔案失敗: "+o.message,"error")}},e.readAsArrayBuffer(B)}function j(){p.value="",B=null,k.classList.add("hidden"),document.querySelector(".upload-content").classList.remove("hidden"),U.classList.add("hidden"),I.disabled=!0,L("請選擇縣市、輸入月份並上傳檔案","")}function re(e,n){const o=[],r=()=>({gender:{男:0,女:0},age:{"<= 49":0,"50 >= && <= 64":0,"65 >= && <= 74":0,"75 >= && <= 84":0,"85 >=":0},living:{},cms:{}});if(e.newTaipei&&e.newTaipei.length>0){const u=J(e.newTaipei,{gender:R.value,age:A.value,living:h.value,cms:a.value});o.push({title:"新北",sheetName:`新北${l.value}`,stats:u,hasData:!0})}else o.push({title:"新北",sheetName:`新北${l.value}`,stats:r(),hasData:!1});if(e.taipei&&e.taipei.length>0){const u=J(e.taipei,{category:s.value,gender:v.value,age:y.value,living:x.value,cms:$.value},!0,"老福");o.push({title:"台北老福",sheetName:`台北老福${l.value}`,stats:u,hasData:u.gender.男+u.gender.女>0});const t=J(e.taipei,{category:s.value,gender:v.value,age:y.value,living:x.value,cms:$.value},!0,"身障");o.push({title:"台北身障",sheetName:`台北身障${l.value}`,stats:t,hasData:t.gender.男+t.gender.女>0})}else o.push({title:"台北老福",sheetName:`台北老福${l.value}`,stats:r(),hasData:!1}),o.push({title:"台北身障",sheetName:`台北身障${l.value}`,stats:r(),hasData:!1});de(o),Y(n)}function le(e,n){const o=parseInt(Q.value||"5"),r=D(M.value||"U"),u=D(q.value||"G"),t=D(X.value||"O"),d={},c={},g={};for(let b=o;b<e.length;b++){const S=e[b];if(r!==-1&&S[r]!==void 0){const i=S[r].toString().trim();i&&(d[i]=(d[i]||0)+1)}if(u!==-1&&S[u]!==void 0){const i=S[u].toString().trim();i&&(c[i]=(c[i]||0)+1)}if(t!==-1&&S[t]!==void 0){const i=S[t].toString().trim();i&&(g[i]=(g[i]||0)+1)}}ue(d,c,g),Y(n)}function Y(e){k.classList.remove("hidden"),k.querySelector(".file-name").textContent=e,document.querySelector(".upload-content").classList.add("hidden"),U.classList.remove("hidden"),L("檔案已就緒，請確認統計結果","success"),G()}function de(e){P.innerHTML="",F&&F.classList.add("hidden"),P.classList.remove("hidden");const n=[];e.forEach(o=>{const{title:r,sheetName:u,stats:t,hasData:d}=o,c=document.createElement("div");if(c.className="preview-group",!d)c.innerHTML=`
                    <div class="preview-group-header">
                        <span class="preview-group-title">${r}</span>
                        <span class="preview-group-badge" style="background: rgba(100,116,139, 0.2); color: #94a3b8;">無資料</span>
                    </div>
                    <div class="stats-grid" style="opacity: 0.5;">
                        <div class="stat-card"><div class="stat-label">狀態</div><div class="stat-values">無資料</div></div>
                    </div>
                `;else{const g=["獨居","獨居(兩老)","與家人或其他人同住","與朋友同住","其他"],b=g.filter(E=>t.living[E]!==void 0).map(E=>`<div class="stat-item"><span>${E}</span> <span class="stat-value">${t.living[E]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>',S=["1","2","3","4","5","6","7","8"],i=Object.keys(t.cms).filter(E=>!S.includes(E)).sort(),w=S.concat(i),O=w.filter(E=>t.cms[E]!==void 0).map(E=>`<div class="stat-item"><span>${E}</span> <span class="stat-value">${t.cms[E]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';c.innerHTML=`
                    <div class="preview-group-header">
                        <span class="preview-group-title">${r}</span>
                        <span class="preview-group-badge">${u}</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">性別統計</div>
                            <div class="stat-values">
                                <div class="stat-item"><span>男</span> <span class="stat-value">${t.gender.男}</span></div>
                                <div class="stat-item"><span>女</span> <span class="stat-value">${t.gender.女}</span></div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">年齡分佈</div>
                            <div class="stat-values">
                                <div class="stat-item"><span><= 49</span> <span class="stat-value">${t.age["<= 49"]}</span></div>
                                <div class="stat-item"><span>50 - 64</span> <span class="stat-value">${t.age["50 >= && <= 64"]}</span></div>
                                <div class="stat-item"><span>65 - 74</span> <span class="stat-value">${t.age["65 >= && <= 74"]}</span></div>
                                <div class="stat-item"><span>75 - 84</span> <span class="stat-value">${t.age["75 >= && <= 84"]}</span></div>
                                <div class="stat-item"><span>>= 85</span> <span class="stat-value">${t.age["85 >="]}</span></div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">居住狀況</div>
                            <div class="stat-values">${b}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">CMS 等級</div>
                            <div class="stat-values">${O}</div>
                        </div>
                    </div>
                `;const N=pe(t.gender,t.living,t.cms,g,w,t.age);n.push({sheetName:u,rows:N})}P.appendChild(c)}),I.dataset.outputPayload=JSON.stringify(n),n.length===0&&(L("警告：所有縣市皆無資料","error"),I.disabled=!0)}function ue(e,n,o){P.classList.add("hidden"),F.classList.remove("hidden");const t=T==="台北"?["松山區","信義區","大安區","中山區","中正區","大同區","萬華區","文山區","南港區","內湖區","士林區","北投區"]:["三重區","蘆洲區","五股區","板橋區","土城區","新莊區","中和區","永和區","樹林區","泰山區","新店區"],d=Object.keys(e).sort((i,w)=>{const O=t.indexOf(i),N=t.indexOf(w);return O!==-1&&N!==-1?O-N:O!==-1?-1:N!==-1?1:i.localeCompare(w,"zh-hant")});ie.innerHTML=d.map(i=>`<div class="stat-item"><span>${i}</span> <span class="stat-value">${e[i]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const c=Object.keys(n).sort((i,w)=>i.localeCompare(w,"zh-hant"));oe.innerHTML=c.map(i=>`<div class="stat-item"><span>${i}</span> <span class="stat-value">${n[i]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const g=["100%","95%","84%"],b=Object.keys(o).sort((i,w)=>{const O=g.indexOf(i),N=g.indexOf(w);return O!==-1&&N!==-1?O-N:O!==-1?-1:N!==-1?1:i.localeCompare(w)});ce.innerHTML=b.map(i=>`<div class="stat-item"><span>${i}</span> <span class="stat-value">${o[i]}</span></div>`).join("")||'<div class="stat-item"><span>無資料</span></div>';const S=ve(e,d,n,c,o,b);I.dataset.outputRows=JSON.stringify(S)}function pe(e,n,o,r,u,t){const d=t||e,c=[["【性別統計】",""],["男",e.男||0],["女",e.女||0],["",""]];return c.push(["【年齡分佈】",""],["<= 49",d["<= 49"]||0],["50 >= && <= 64",d["50 >= && <= 64"]||0],["65 >= && <= 74",d["65 >= && <= 74"]||0],["75 >= && <= 84",d["75 >= && <= 84"]||0],["85 >=",d["85 >="]||0],["",""]),c.push(["【居住狀況】",""]),r.forEach(g=>{n[g]!==void 0&&c.push([g,n[g]])}),c.push(["",""],["【CMS 等級】",""]),u.forEach(g=>{o[g]!==void 0&&c.push([g,o[g]])}),c}function ve(e,n,o,r,u,t){const d=[["【行政區統計】",""]];return n.forEach(c=>d.push([c,e[c]])),d.push(["",""],["【服務項目類別】",""]),r.forEach(c=>d.push([c,o[c]])),d.push(["",""],["【補助比率】",""]),t.forEach(c=>d.push([c,u[c]])),d}function G(){const e=C==="case"||T!=="",n=l.value.length>=2,o=!!B;let r=!1;if(C==="case"){const u=s.value.trim()&&v.value.trim()&&y.value.trim()&&x.value.trim()&&$.value.trim(),t=R.value.trim()&&A.value.trim()&&h.value.trim()&&a.value.trim();r=u&&t}else r=M.value.trim()&&q.value.trim()&&X.value.trim();I.disabled=!(e&&n&&r&&o)}[l,s,v,y,x,$,R,A,h,a,M,q,X,Q].forEach(e=>{e.addEventListener("input",()=>{G(),B&&_()}),e.addEventListener("change",()=>{G(),B&&_()})}),I.onclick=async()=>{if(C==="service"&&!T){L("請選擇縣市","error");return}if(l.value.length<2){L("請輸入月份","error");return}ee(!0),L("正在同步至 Google Sheet...","success");try{if(C==="case"){const e=JSON.parse(I.dataset.outputPayload||"[]");for(const n of e)await fetch(Z,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}else{const e=JSON.parse(I.dataset.outputRows||"[]");let n=T;T==="台北"&&(n=`台北${document.querySelector('input[name="tpServiceCategory"]:checked').value}`);const o=n+l.value;await fetch(Z,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:o,rows:e})})}L("同步完成！請檢查您的 Google Sheet","success")}catch(e){console.error(e),L("同步失敗: "+e.message,"error")}finally{ee(!1)}};function ee(e){I.disabled=e,I.querySelector(".btn-text").classList.toggle("hidden",e),I.querySelector(".loader").classList.toggle("hidden",!e)}function L(e,n){z.textContent=e,z.className="status-message "+n}});
